---
title: "Eksploracja Masywnych Danych - Analiza danych"
author: "Kajetan Zimniak & Bartosz Górka"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  md_document:
    variant: markdown_github
  html_document:
    toc: true
    df_print: paged
  pdf_document: 
    toc: true
---
```{r setup, include=FALSE}
pdf.options(encoding = 'CP1250')
knitr::opts_chunk$set(echo = TRUE)
```

# Podsumowanie analizy
TODO: Podsumowanie na koniec

# Wykorzystane biblioteki
* `knitr`
* `dplyr`
* `tidyverse`
* `ggplot2`
* `gridExtra`
* `imputeTS`
* `corrplot`
* `reshape2`

# Ustawienie ziarna generatora
Celem zapewnienia powtarzalności operacji losowania, a co za tym idzie powtarzalności wyników przy każdym uruchomieniu raportu na tych samych danych zastosowano ziarno generatora o wartości `102019`.

```{r ziarno-losowosci}
set.seed(102019)
```

# Charakterystyka obserwacji - zastosowane atrybuty
W ramach analizy mamy do czynienia z obserwacjami opisanymi za pomocą następujących atrybutów:

* **length**: długość złowionego śledzia [cm]
* **cfin1**: dostępność planktonu [zagęszczenie *Calanus finmarchicus* gat. 1]
* **cfin2**: dostępność planktonu [zagęszczenie *Calanus finmarchicus* gat. 2];
* **chel1**: dostępność planktonu [zagęszczenie *Calanus helgolandicus* gat. 1];
* **chel2**: dostępność planktonu [zagęszczenie *Calanus helgolandicus* gat. 2];
* **lcop1**: dostępność planktonu [zagęszczenie *widłonogów* gat. 1];
* **lcop2**: dostępność planktonu [zagęszczenie *widłonogów* gat. 2];
* **fbar**: natężenie połowów w regionie [ułamek pozostawionego narybku];
* **recr**: roczny narybek [liczba śledzi];
* **cumf**: łączne roczne natężenie połowów w regionie [ułamek pozostawionego narybku];
* **totaln**: łączna liczba ryb złowionych w ramach połowu [liczba śledzi];
* **sst**: temperatura przy powierzchni wody [°C];
* **sal**: poziom zasolenia wody [Knudsen ppt];
* **xmonth**: miesiąc połowu [numer miesiąca];
* **nao**: oscylacja północnoatlantycka [mb].

# Wczytanie danych z pliku
Dane zamieszczone na stronie przedmiotu w postaci pliku CSV pobieramy wyłącznie w sytuacji braku pliku w katalogu roboczym. Pozwala to nam na ograniczenie niepotrzebnego transferu danych, jeżeli plik już istnieje.
```{r pobranie danych}
file_name = "sledzie.csv"
source_url = "http://www.cs.put.poznan.pl/alabijak/emd/projekt/sledzie.csv"

if (!file.exists(file_name)) {
  download.file(source_url, destfile = file_name, method = "wget")
}
```

Po ewentualnym pobraniu wczytujemy dane do pamięci.
```{r wczytanie-danych, message = FALSE, warning = FALSE}
library('knitr')
library('dplyr')
library('tidyverse')

content =
  file_name %>%
  read_csv(col_names = TRUE, na = c("", "NA", "?")) %>%
  select(-1)

content[0:11] %>%
  head(n = 5) %>%
  kable(align = 'c', caption = 'Wybrane pomiary')
```

Oryginalnie zbiór posiada znaki `?` jako oznaczenie wartości pustej (brakującej). Dzięki wykorzystaniu parametru `na` podczas wywołania funkcji `read_csv` możemy zastąpić znak `?` poprawnym oznaczeniem braku wartości `NA`. W tabeli `Wybrane pomiary` zaprezentowano pierwsze pięć obserwacji.

# Podstawowe statystyki zbioru danych
```{r, ECHO = FALSE}
total_records = count(content)
total_records_without_na_values = count(na.omit(content))
```
W zbiorze danych mamy do czynienia z `r total_records` obserwacjami opisanych za pomocą `r length(content)` atrybutów. W całym zbiorze mamy do czynienia z `r total_records_without_na_values` obserwacjami bez wartości pustych co stanowi `r format((total_records_without_na_values/total_records) * 100, digits = 2)` procent całego zbioru.

## Statystyka parametrów obserwacji
```{r, statystyka-zbioru-danych}
content %>%
  summary() %>%
  kable(align = 'c', caption = 'Statystyka zbioru danych')
```

TODO: Poprawić tabelkę, nie mieści się na stronie PDF

## Rozkład wartości cech
```{r, cechy1, ECHO = FALSE, message = FALSE, warning = FALSE}
library('ggplot2')
library('gridExtra')

ggplot(content, aes(x = length)) + geom_histogram(binwidth = 0.25) + 
  theme_bw() + ggtitle('Długość złowionego śledzia [cm]') + 
  xlab(sprintf('Długość [cm]')) + ylab('Liczba obserwacji')
```
Jak możemy zaobserwować, większość śledzi w połowie ma długość od 23 do 27 centymetrów.

```{r, cechy2, ECHO = FALSE, message = FALSE, warning = FALSE}
plot_cfin1 <- ggplot(content, aes(x = cfin1)) + geom_histogram(binwidth = 1.0) +
  theme_bw() + ggtitle('Calanus finmarchicus gat. 1') + 
  xlab(sprintf('Zagęszczenie planktonu [j]')) + ylab('Liczba obserwacji')

plot_cfin2 <- ggplot(content, aes(x = cfin2)) + geom_histogram(binwidth = 1.0) +
  theme_bw() + ggtitle('Calanus finmarchicus gat. 2') + 
  xlab(sprintf('Zagęszczenie planktonu [j]')) + ylab('Liczba obserwacji')

grid.arrange(plot_cfin1, plot_cfin2, nrow = 1)
```

```{r, cechy3, ECHO = FALSE, message = FALSE, warning = FALSE}
plot_chel1 <- ggplot(content, aes(x = chel1)) + geom_histogram(binwidth = 0.5) +
  theme_bw() + ggtitle('Calanus helgolandicus gat. 1') + 
  xlab(sprintf('Zagęszczenie planktonu [j]')) + ylab('Liczba obserwacji')

plot_chel2 <- ggplot(content, aes(x = chel2)) + geom_histogram(binwidth = 0.5) +
  theme_bw() + ggtitle('Calanus helgolandicus gat. 2') + 
  xlab(sprintf('Zagęszczenie planktonu [j]')) + ylab('Liczba obserwacji')

grid.arrange(plot_chel1, plot_chel2, nrow = 1)
```
```{r, cechy4, ECHO = FALSE, message = FALSE, warning = FALSE}
plot_lcop1 <- ggplot(content, aes(x = lcop1)) + geom_histogram(binwidth = 0.5) +
  theme_bw() + ggtitle('Widłonogi gat. 1') + 
  xlab(sprintf('Zagęszczenie planktonu [j]')) + ylab('Liczba obserwacji')

plot_lcop2 <- ggplot(content, aes(x = lcop2)) + geom_histogram(binwidth = 0.5) +
  theme_bw() + ggtitle('Widłonogi gat. 2') + 
  xlab(sprintf('Zagęszczenie planktonu [j]')) + ylab('Liczba obserwacji')

grid.arrange(plot_lcop1, plot_lcop2, nrow = 1)
```

```{r, cechy5, ECHO = FALSE, message = FALSE, warning = FALSE}
plot_fbar <- ggplot(content, aes(x = fbar)) + geom_histogram(binwidth = 0.05) +
  theme_bw() + ggtitle('Natężenie połowów') + 
  xlab(sprintf('Ułamek pozostawionego narybku')) + ylab('Liczba obserwacji')

plot_recr <- ggplot(content, aes(x = recr)) + geom_histogram(binwidth = 50000.0) +
  theme_bw() + ggtitle('Roczny narybek') + 
  xlab(sprintf('Liczba śledzi')) + ylab('Liczba obserwacji')

plot_cumf <- ggplot(content, aes(x = cumf)) + geom_histogram(binwidth = 0.02) +
  theme_bw() + ggtitle('Łączne roczne natężenie połowów') + 
  xlab(sprintf('Ułamek pozostawionego narybku')) + ylab('Liczba obserwacji')

plot_totaln <- ggplot(content, aes(x = totaln)) + geom_histogram(binwidth = 1000.0) +
  theme_bw() + ggtitle('Łączna liczba złowionych ryb') + 
  xlab(sprintf('Liczba śledzi')) + ylab('Liczba obserwacji')

grid.arrange(plot_fbar, plot_recr, plot_cumf, plot_totaln, nrow = 2)
```

```{r, cechy6, ECHO = FALSE, message = FALSE, warning = FALSE}
plot_sst <- ggplot(content, aes(x = sst)) + geom_histogram(binwidth = 0.1) +
  theme_bw() + ggtitle('Temperatura przy powierzchni wody') + 
  xlab(sprintf('Temperatura')) + ylab('Liczba obserwacji')

plot_sal <- ggplot(content, aes(x = sal)) + geom_histogram(binwidth = 0.01) +
  theme_bw() + ggtitle('Poziom zasolenia wody') + 
  xlab(sprintf('Zasolenie wody')) + ylab('Liczba obserwacji')

plot_xmonth <- ggplot(content, aes(x = xmonth)) + geom_histogram(binwidth = 0.5) +
  theme_bw() + ggtitle('Miesic połowu') + 
  xlab(sprintf('Miesiąc')) + ylab('Liczba obserwacji')

plot_nao <- ggplot(content, aes(x = nao)) + geom_histogram(binwidth = 0.5) +
  theme_bw() + ggtitle('Oscylacja północnoatlantycka') + 
  xlab(sprintf('Oscylacja')) + ylab('Liczba obserwacji')

grid.arrange(plot_sst, plot_sal, plot_xmonth, plot_nao, nrow = 2)
```

Analizując przedstawione wykresy dotyczące poszczególnych atrybutów opisujących połowy możemy zaobserwować rozkład zbliżony do normalnego dla wielu z nich (chociażby parametr długości śledzia). W przypadku parametrów dostępności planktonu *Calanus finmarchicus gat. 1* oraz *Widłonogów gat. 1* obserwujemy występowanie drobnej próbki danych odbierających znacząco od reszty. Na potrzeby dalszego przetwarzania dane zostaną oczyszczone z tych obserwacji odstających.

TODO: Można opisać pozostałe wykresy bazując na danych w tabeli poprzedniej (min, max ...)

```{r obserwacje-odstajace}
without_outliers =
  content %>%
  filter(cfin1 <= 10 | is.na(cfin1)) %>%
  filter(lcop1 <= 90 | is.na(lcop1))
```
Po operacji w zbiorze obserwacji pozostało `r count(without_outliers)` próbek (usunięto `r count(content) - count(without_outliers)` obserwacji).

```{r, cechy7, ECHO = FALSE, message = FALSE, warning = FALSE}
plot_cfin1_clear <- ggplot(without_outliers, aes(x = cfin1)) + geom_histogram(binwidth = 1.0) +
  theme_bw() + ggtitle('Calanus finmarchicus gat. 1') + 
  xlab(sprintf('Zagęszczenie planktonu [j]')) + ylab('Liczba obserwacji')

plot_lcop1_clear <- ggplot(without_outliers, aes(x = lcop1)) + geom_histogram(binwidth = 0.5) +
  theme_bw() + ggtitle('Widłonogi gat. 1') + 
  xlab(sprintf('Zagęszczenie planktonu [j]')) + ylab('Liczba obserwacji')

grid.arrange(plot_cfin1_clear, plot_lcop1_clear, nrow = 1)
```

# Przetwarzanie brakujących danych
Korzystajac z pakietu `imputeTS` i funkcji `statsNA` możemy przeprowadzić analizę wartości pustych w poszczególnych obserwacjach.
```{r analiza-wartosci-na, message = FALSE, warnings = FALSE}
library('imputeTS')

without_outliers %>%
  colnames() %>%
  sapply(function(attr) {
    statsNA(without_outliers[[attr]], printOnly = FALSE)
  }) %>%
  kable()
```

TODO: Poprawić tabelkę, źle wygląda w PDF

Analizując zaprezentowane podsumowania dla wszystkich atrybutów, możemy zauważyć że wartości puste stanowią mniej niż 3.5% całego zbioru obserwacji. Ponadto ich rozkład ma charater losowy oraz są równomierne. W danych nie występują długie serie wartości pustych (sekwencje liczące dwie oraz trzy wartości puste są rzadkie). Wykorzystując wiedzę o charakterystyce danych możemy wykonać interpolację z wykorzystaniem filtru Kalmana, aby pozbyć się wartości pustych.

```{r kalman}
without_outliers$cfin1 <- na_kalman(without_outliers$cfin1)
without_outliers$cfin2 <- na_kalman(without_outliers$cfin2)
without_outliers$chel1 <- na_kalman(without_outliers$chel1)
without_outliers$chel2 <- na_kalman(without_outliers$chel2)
without_outliers$lcop1 <- na_kalman(without_outliers$lcop1)
without_outliers$lcop2 <- na_kalman(without_outliers$lcop2)
without_outliers$sst <- na_kalman(without_outliers$sst)
```

TODO: Użyć jakieś funkcji

# Korelacja atrybutów
```{r korelacja, message = FALSE, warnings = FALSE}
library('corrplot')

corelation_matrix <- cor(without_outliers)
corrplot(corelation_matrix, method = "circle", title = "Macierz korelacji")
```

Na wykresie powyższym została przedstawiona macierz korelacji pomiędzy poszczególnymi atrybutami. Jak możemy zaobserwować, istnieje bardzo silna pozytywna korelacja pomiędzy parametrem `chel1` oraz `lcop1` (wynosząca w przybliżeniu `0.96`), a także `chel2` oraz `lcop2` (wynosząca `0.88`). Wynika z tego że występowanie planktonu `Calanus helgolandicus gat. 1` związane jest z obecnością `widłonogów gat. 1` i vice versa. Podobnie w przypadku planktonów drugiego gatunku czyli pary `Calanus helgolandicus gat. 2` oraz `widłonogi gat. 2`.

Analizując dalej macierz korelacji możemy zaobserwować pozytywną zależność pomiędzy `cfin2` i `lcop2` wynosząca `0.65` - zagęszczenie `Calanus finmarchicus gat. 2` ma powiązanie w obecności `widłonogów gat. 2`.

Ciekawą zależnością jest `sst` oraz `nao`. Korzystając z opisu `oscylacji północnoatlantyckiej` na stronie encyklopedii [Wikipedia](https://pl.wikipedia.org/wiki/Oscylacja_p%C3%B3%C5%82nocnoatlantycka) mamy do czynienia ze zjawiskiem meterologicznym wpływającym na klimat, co manifestuje się między innymi zmianą temperatury. Podkreśla to wiarygodność naszych obserwacji, gdyż doszło do odwzorowania zjawiska fizycznego w naszych danych.

Wysoką wartość zależności `fbar` oznaczającej `natężenia połowów w regionie` oraz `cumf` czyli `łączne roczne natężenie połowów w regionie` wynoszącej `0.82` można łatwo wyjaśnić. Łowienie w danym miejscu przez długi czas sumarycznie wpłynie na wysoką wartość drugiego parametru.

Interesującą z punktu widzenia tematu raportu jest zależność temperatury przy powierzchni wody i długości złowionego śledzia. Wynosi ona `-0.45`. Większa temperatura ma odzwierciedlenie w mniejszych rozmiarach śledzi.

TODO: Dodać wykresy dla porównań
TODO: Poprawić ten opis aby dać tekst a nie same nazwy kolumn

# Zmienność cech w ramach następujących po siebie połowów
W kolejnych podrozdziałach zostanie przeanalizowana zmienność cech. Naszym celem jest wykrycie przyczyny spadku długości śledzi w połowach.

## Długość śledzi
```{r, ECHO = FALSE, CACHE = TRUE}
df_with_ids <- mutate(without_outliers, id = as.numeric(rownames(without_outliers)))
sampled_data <- sample_n(df_with_ids, 500)
```

```{r, dlugosc-sledzi, message = FALSE, warnings = FALSE}
zmiana_sledzi_plot <- ggplot(
  sampled_data,
  aes(x=id, y=length)
) + theme_bw() + 
  theme(axis.text.x=element_blank()) + geom_point() + geom_smooth(method = 'loess', formula = y ~ x, se = FALSE, colour = "#f5ad00", size = 1.0) + ggtitle('Zmiana długości śledzia') +  xlab('') + ylab('Długość [cm]') + geom_vline(xintercept = 17000, colour="blue", linetype = 2, size = 1.0)

zmiana_sledzi_plot
```

TODO: Opisać wykres

```{r zmiana-rozmiaru-animacja}
library('gganimate')
library('gifski')

ggplot(
  sampled_data,
  group = xmonth,
  aes(x=id, y=length)
) + theme_bw() + 
  geom_line() + transition_reveal(id)
```

TODO: Źródło danych w postaci uśrednionych danych z połowów
TODO: Opisać wykres
TODO: W PDF bez tej animacji

## Dostępność pokarmu
```{r, dostepnosc-pokarmu, message = FALSE, warnings = FALSE}
library('reshape2')

plancton_food <- melt(sampled_data[, c(16, 2:7)], id.vars = c('id'), variable.name = "TypPlanktonu", value.name = "Values")
ggplot(
  plancton_food,
  aes(id, Values, color = TypPlanktonu)
) + theme_bw() + 
  theme(axis.text.x=element_blank()) + geom_smooth(se = FALSE) + ggtitle('Zmiana dostępności pokarmu') +  xlab('') + ylab('Dostępność pokarmu [zagęszczenie]') + geom_vline(xintercept = 17000, colour="blue", linetype = 2, size = 1.0)
```

TODO: Opisać wykres

## Parametry środowiska
```{r, srodowisko, message = FALSE, warnings = FALSE}
parametry_srodowiska <- sampled_data[, c(12, 13, 15)]
normalized_environment <- as.data.frame(lapply(parametry_srodowiska, function(x) {
  (x - min(x)) / (max(x) - min(x))
}))
normalized_environment["id"] <- sampled_data[, 16]

environment <- melt(normalized_environment, id.vars = c('id'), variable.name = "Środowisko", value.name = "Values")
ggplot(
  environment,
  aes(id, Values, color = Środowisko)
) + theme_bw() + 
  theme(axis.text.x=element_blank()) + geom_smooth(se = FALSE) + ggtitle('Zmiana warunków środowiska') +  xlab('') + ylab('Środowisko (znormalizowana wartość)') + geom_vline(xintercept = 17000, colour="blue", linetype = 2, size = 1.0)
```

TODO: Opisać wykres

## Eksploatacja łowiska
```{r, lowisko, message = FALSE, warnings = FALSE}
parametry_lowiska <- sampled_data[, c(8:11)]
normalized_lowisko <- as.data.frame(lapply(parametry_lowiska, function(x) {
  (x - min(x)) / (max(x) - min(x))
}))
normalized_lowisko["id"] <- sampled_data[, 16]

lowisko <- melt(normalized_lowisko, id.vars = c('id'), variable.name = "Łowisko", value.name = "Values")
ggplot(
  lowisko,
  aes(id, Values, color = Łowisko)
) + theme_bw() + 
  theme(axis.text.x=element_blank()) + geom_smooth(se = FALSE) + ggtitle('Zmiana warunków eksploracji łowiska') +  xlab('') + ylab('Łowisko (znormalizowana wartość)') + geom_vline(xintercept = 17000, colour="blue", linetype = 2, size = 1.0)
```

TODO: Opisać wykres

# Regresor - predykcja 
TODO: Dwa regresory
TODO: Wskazanie najważniejszych cech
TODO: Obliczenie błędów